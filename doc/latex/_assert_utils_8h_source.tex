\doxysection{Assert\+Utils.\+h}
\hypertarget{_assert_utils_8h_source}{}\label{_assert_utils_8h_source}\index{src/AssertUtils.h@{src/AssertUtils.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ <cassert>}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <winerror.h>}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ <exception>}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ <DirectXMath.h>}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <stdexcept>}}
\DoxyCodeLine{00009\ \textcolor{preprocessor}{\#include\ <wrl.h>}}
\DoxyCodeLine{00010\ \textcolor{keyword}{using\ namespace\ }Microsoft::WRL;}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ <DirectX-\/Headers/include/directx/d3dx12.h>}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ ThrowIfFailed(HRESULT\ hr)}
\DoxyCodeLine{00014\ \{}
\DoxyCodeLine{00015\ \ \ \ \ \textcolor{keywordflow}{if}\ (FAILED(hr))}
\DoxyCodeLine{00016\ \ \ \ \ \{}
\DoxyCodeLine{00017\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::exception();}
\DoxyCodeLine{00018\ \ \ \ \ \}}
\DoxyCodeLine{00019\ \}}
\DoxyCodeLine{00020\ }
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{keyword}{inline}\ std::vector<DirectX::XMFLOAT3>\ ReadBackVertexBuffer(ID3D12Device*\ device,}
\DoxyCodeLine{00023\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ID3D12GraphicsCommandList*\ commandList,}
\DoxyCodeLine{00024\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ID3D12CommandQueue*\ commandQueue,}
\DoxyCodeLine{00025\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ID3D12Resource*\ vertexBuffer)}
\DoxyCodeLine{00026\ \{}
\DoxyCodeLine{00027\ \ \ \ \ \textcolor{comment}{//\ Describe\ and\ create\ the\ readback\ buffer.}}
\DoxyCodeLine{00028\ \ \ \ \ D3D12\_RESOURCE\_DESC\ vertexBufferDesc\ =\ vertexBuffer-\/>GetDesc();}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \ \ \ \ D3D12\_HEAP\_PROPERTIES\ heapProps\ =\ \{\};}
\DoxyCodeLine{00031\ \ \ \ \ heapProps.Type\ =\ D3D12\_HEAP\_TYPE\_READBACK;}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \ \ \ \ Microsoft::WRL::ComPtr<ID3D12Resource>\ readbackBuffer;}
\DoxyCodeLine{00034\ \ \ \ \ HRESULT\ hr\ =\ device-\/>CreateCommittedResource(}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \ \ \ \ \&heapProps,}
\DoxyCodeLine{00036\ \ \ \ \ \ \ \ \ \ \ \ \ D3D12\_HEAP\_FLAG\_NONE,}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \ \ \ \ \&vertexBufferDesc,}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \ \ \ \ D3D12\_RESOURCE\_STATE\_COPY\_DEST,}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{nullptr},}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \ \ \ \ IID\_PPV\_ARGS(\&readbackBuffer)}
\DoxyCodeLine{00041\ \ \ \ \ );}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{keywordflow}{if}\ (FAILED(hr))\ \{}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Failed\ to\ create\ readback\ buffer."{}});}
\DoxyCodeLine{00045\ \ \ \ \ \}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{comment}{//\ Copy\ the\ vertex\ buffer\ contents\ to\ the\ readback\ buffer.}}
\DoxyCodeLine{00048\ \ \ \ \ commandList-\/>CopyResource(readbackBuffer.Get(),\ vertexBuffer);}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \ \ \ \ \textcolor{comment}{//\ Execute\ the\ command\ list\ and\ wait\ for\ it\ to\ finish.}}
\DoxyCodeLine{00051\ \ \ \ \ commandList-\/>Close();}
\DoxyCodeLine{00052\ \ \ \ \ ID3D12CommandList*\ ppCommandLists[]\ =\ \{\ commandList\ \};}
\DoxyCodeLine{00053\ \ \ \ \ commandQueue-\/>ExecuteCommandLists(\_countof(ppCommandLists),\ ppCommandLists);}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \ \ \ \ \textcolor{comment}{//\ Create\ a\ fence\ and\ an\ event\ handle\ for\ synchronization.}}
\DoxyCodeLine{00056\ \ \ \ \ Microsoft::WRL::ComPtr<ID3D12Fence>\ fence;}
\DoxyCodeLine{00057\ \ \ \ \ UINT64\ fenceValue\ =\ 1;}
\DoxyCodeLine{00058\ \ \ \ \ hr\ =\ device-\/>CreateFence(0,\ D3D12\_FENCE\_FLAG\_NONE,\ IID\_PPV\_ARGS(\&fence));}
\DoxyCodeLine{00059\ \ \ \ \ \textcolor{keywordflow}{if}\ (FAILED(hr))\ \{}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Failed\ to\ create\ fence."{}});}
\DoxyCodeLine{00061\ \ \ \ \ \}}
\DoxyCodeLine{00062\ }
\DoxyCodeLine{00063\ \ \ \ \ HANDLE\ fenceEvent\ =\ CreateEvent(\textcolor{keyword}{nullptr},\ FALSE,\ FALSE,\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00064\ \ \ \ \ \textcolor{keywordflow}{if}\ (!fenceEvent)\ \{}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Failed\ to\ create\ fence\ event."{}});}
\DoxyCodeLine{00066\ \ \ \ \ \}}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \ \ \textcolor{comment}{//\ Signal\ and\ wait\ for\ the\ GPU\ to\ finish.}}
\DoxyCodeLine{00069\ \ \ \ \ hr\ =\ commandQueue-\/>Signal(fence.Get(),\ fenceValue);}
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{keywordflow}{if}\ (FAILED(hr))\ \{}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ CloseHandle(fenceEvent);}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Failed\ to\ signal\ command\ queue."{}});}
\DoxyCodeLine{00073\ \ \ \ \ \}}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{keywordflow}{if}\ (fence-\/>GetCompletedValue()\ <\ fenceValue)\ \{}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ hr\ =\ fence-\/>SetEventOnCompletion(fenceValue,\ fenceEvent);}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (FAILED(hr))\ \{}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ CloseHandle(fenceEvent);}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Failed\ to\ set\ event\ on\ completion."{}});}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ WaitForSingleObject(fenceEvent,\ INFINITE);}
\DoxyCodeLine{00082\ \ \ \ \ \}}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ \ \ CloseHandle(fenceEvent);}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{comment}{//\ Map\ the\ readback\ buffer\ to\ CPU\ memory.}}
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{keywordtype}{void}*\ pData\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00088\ \ \ \ \ D3D12\_RANGE\ readRange\ =\ \{\ 0,\ 0\ \};\ \textcolor{comment}{//\ We\ do\ not\ intend\ to\ write\ to\ this\ resource\ on\ the\ CPU}}
\DoxyCodeLine{00089\ \ \ \ \ hr\ =\ readbackBuffer-\/>Map(0,\ \&readRange,\ \&pData);}
\DoxyCodeLine{00090\ }
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{keywordflow}{if}\ (FAILED(hr))\ \{}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ std::runtime\_error(\textcolor{stringliteral}{"{}Failed\ to\ map\ readback\ buffer."{}});}
\DoxyCodeLine{00093\ \ \ \ \ \}}
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00095\ \ \ \ \ \textcolor{comment}{//\ Access\ the\ data.}}
\DoxyCodeLine{00096\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ vertexCount\ =\ vertexBufferDesc.Width\ /\ \textcolor{keyword}{sizeof}(DirectX::XMFLOAT3);}
\DoxyCodeLine{00097\ \ \ \ \ std::vector<DirectX::XMFLOAT3>\ vertices(vertexCount);}
\DoxyCodeLine{00098\ \ \ \ \ memcpy(vertices.data(),\ pData,\ vertexBufferDesc.Width);}
\DoxyCodeLine{00099\ }
\DoxyCodeLine{00100\ \ \ \ \ \textcolor{comment}{//\ Unmap\ the\ resource.}}
\DoxyCodeLine{00101\ \ \ \ \ D3D12\_RANGE\ writtenRange\ =\ \{\ 0,\ 0\ \};\ \textcolor{comment}{//\ Indicate\ that\ we\ haven't\ written\ to\ the\ buffer}}
\DoxyCodeLine{00102\ \ \ \ \ readbackBuffer-\/>Unmap(0,\ \&writtenRange);}
\DoxyCodeLine{00103\ }
\DoxyCodeLine{00104\ \ \ \ \ \textcolor{keywordflow}{return}\ vertices;}
\DoxyCodeLine{00105\ \}}

\end{DoxyCode}
